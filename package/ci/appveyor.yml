# kate: indent-width 2;

skip_tags: true
shallow_clone: true
clone_depth: 1

os: Visual Studio 2015

environment:
  matrix:
  - TARGET: desktop
    COMPILER: msvc
    ARCHITECTURE: x86
  - TARGET: desktop
    COMPILER: msvc
    ARCHITECTURE: amd64
  - TARGET: desktop
    COMPILER: mingw
    ARCHITECTURE: amd64

notifications:
- provider: Webhook
  url: https://webhooks.gitter.im/e/415ae90928ba0dbd3df4
  on_build_success: false
  on_build_failure: true
  on_build_status_changed: true

install:
- cinst ninja
- set PATH=C:/tools/ninja;%PATH%
- IF "%TARGET%" == "desktop" IF "%COMPILER%" == "mingw" cinst mingw /f >nul

# OpenAL
- IF NOT "%TARGET%" == "rt" IF NOT EXIST %APPVEYOR_BUILD_FOLDER%\openal-soft-1.17.2-bin.zip appveyor DownloadFile http://kcat.strangesoft.net/openal-binaries/openal-soft-1.17.2-bin.zip
- IF NOT "%TARGET%" == "rt" 7z x openal-soft-1.17.2-bin.zip && ren openal-soft-1.17.2-bin openal && echo [General] > %APPDATA%/alsoft.ini & echo drivers=null >> %APPDATA%/alsoft.ini
- IF "%ARCHITECTURE%" == "x86" ren openal\bin\Win32\soft_oal.dll OpenAL32.dll
- IF "%ARCHITECTURE%" == "amd64" ren openal\bin\Win64\soft_oal.dll OpenAL32.dll

# LibJPEG Turbo
- IF NOT EXIST %APPVEYOR_BUILD_FOLDER%\libjpeg-turbo-1.2.0.tar.gz appveyor DownloadFile http://downloads.sourceforge.net/project/libjpeg-turbo/1.2.0/libjpeg-turbo-1.2.0.tar.gz
- 7z x libjpeg-turbo-1.2.0.tar.gz
- 7z x libjpeg-turbo-1.2.0.tar
- ren libjpeg-turbo-1.2.0 libjpeg-turbo

build_script:
- IF "%TARGET%" == "desktop" IF "%COMPILER%" == "msvc" IF "%ARCHITECTURE%" == "amd64" call package\ci\appveyor-desktop-amd64.bat
- IF "%TARGET%" == "desktop" IF "%COMPILER%" == "msvc" IF "%ARCHITECTURE%" == "x86" call package\ci\appveyor-desktop.bat
- IF "%TARGET%" == "desktop" IF "%COMPILER%" == "mingw" call package\ci\appveyor-desktop-mingw.bat

cache:
- openal-soft-1.17.2-bin.zip
- libjpeg-turbo-1.2.0.tar.gz

test_script:
- cd %APPVEYOR_BUILD_FOLDER%/build
- SET fail=0
- ctest --output-on-failure -E GLTest || SET fail=1 & ver > nul
- cd %APPVEYOR_BUILD_FOLDER%
- appveyor PushArtifact magnum-plugins.zip
- exit %fail%
